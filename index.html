<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Music Player</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --ply-primary:#A855F7;
      --ply-secondary:#7C3AED;
      --bg-color:#ffffff;
      --title-size:18px;
      --meta-size:14px;
    }
    html, body { margin:0; padding:0; background:var(--bg-color); }
    body{font-family:'Noto Sans KR',sans-serif}
    .card{ background:#fff; border-radius:20px; box-shadow:0 10px 25px -5px rgba(0,0,0,.1),0 10px 10px -5px rgba(0,0,0,.04); }

    /* ===== Player (보라 카드) ===== */
    #player{ display:flex; flex-direction:column; color:#fff; background:linear-gradient(90deg,var(--ply-primary),var(--ply-secondary)); border-radius:1rem; box-shadow:0 10px 25px -5px rgba(0,0,0,.15),0 10px 10px -5px rgba(0,0,0,.05); width:100%}
    .player-top{ display:flex; width:100%; align-items:center; padding:1rem; gap:1rem; }
    #player .album-art{width:5rem;height:5rem}
    .text-glow{ text-shadow:0 1px 2px rgba(0,0,0,.25); }
    .title-text{ font-size:var(--title-size); line-height:1.2; }
    .meta-text{ font-size:var(--meta-size); }
    .player-buttons button { cursor: pointer; transition: transform 0.1s ease; }
    .player-buttons button:active { transform: scale(0.9); }
    #waveformCanvas{width:140px;height:44px}

    /* ===== 세로형 레이아웃 ===== */
    #player.vertical .player-top{ flex-direction:column; justify-content:center; text-align:center; padding:1.25rem 1rem; }
    #player.vertical .album-art{ width:7rem; height:7rem; }
    #player.vertical .player-controls{ width:100%; justify-content:center; margin-top:.25rem; }
    #player.vertical .player-buttons{ justify-content:center; }
    #player.vertical #waveformCanvas{ display:none; } /* 세로형에서는 파형 숨김 */

    /* ===== 결과 섹션 내부 스크롤 ===== */
    .results-grid{
      max-height: 460px;
      overflow-y: auto;
      padding-right: 4px;
      overscroll-behavior: contain;
    }
    @media (max-width: 640px){
      .results-grid{ max-height: 320px; }
    }
    .results-grid::-webkit-scrollbar{width:8px}
    .results-grid::-webkit-scrollbar-track{background:#f1f1f1;border-radius:10px}
    .results-grid::-webkit-scrollbar-thumb{background:#C4B5FD;border-radius:10px}
    .results-grid::-webkit-scrollbar-thumb:hover{background:#A78BFA}

    /* ===== 보라 카드 상단 고정 ===== */
    .sticky-card{
      position: sticky;
      top: 1rem;   /* 꼭대기에 붙이려면 0 */
      z-index: 40; /* 설정 패널(z-50)보다 낮게 */
    }

    /* 설정 패널 애니메이션 */
    #settingsPanel{opacity:0;transform:scale(.95) translateY(10px);transition:opacity .2s,transform .2s;pointer-events:none}
    #settingsPanel.open{opacity:1;transform:scale(1) translateY(0);pointer-events:auto}

    /* 토글 버튼 스타일 */
    .toggle-tab{ @apply h-9 px-3 text-sm rounded-md border; }
    .tab-active{ background:#8b5cf6; color:#fff; border-color:#8b5cf6; }
    .tab-inactive{ background:#f3f4f6; color:#111827; border-color:#e5e7eb; }
  </style>
</head>
<body class="flex justify-center min-h-screen pt-8">
  <div class="w-full max-w-3xl mx-auto p-4">
    <!-- ===== 보라색 플레이어 카드 (상단 고정) ===== -->
    <section class="mb-4 sticky-card">
      <div id="player" data-layout="horizontal">
        <div class="player-top">
          <img id="albumArt" src="data:image/svg+xml;utf8,<?xml version='1.0' encoding='UTF-8'?><svg xmlns='http://www.w3.org/2000/svg' width='80' height='80'><rect width='100%' height='100%' rx='10' fill='%236d28d9'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='14' fill='%23ffffff'>Cover</text></svg>" alt="Album Art" class="album-art rounded-lg shadow-md flex-shrink-0 transition-all">
          <div class="flex-grow min-w-0 ml-0 sm:ml-2">
            <h2 class="font-bold flex flex-wrap items-baseline justify-center sm:justify-start gap-1 text-glow title-text">
              <span id="trackTitle" class="truncate">노래 제목</span>
              <span id="trackArtist" class="opacity-90"></span>
            </h2>
            <div class="flex items-center justify-center sm:justify-start opacity-90 text-glow meta-text">
              <span class="mr-2">SING 🎤</span><p id="artistName">채널명</p>
            </div>
          </div>

          <div class="player-controls flex items-center ml-0 sm:ml-auto">
            <div class="player-buttons flex items-center space-x-2">
              <button id="prevBtn" aria-label="Previous" class="text-white/95">
                <svg class="w-8 h-8" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M5 5a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h1a1 1 0 0 0 1-1V6a1 1 0 0 0-1-1H5z"/>
                  <path d="M18 6.5a1 1 0 0 0-1.55-.832l-8 5a1 1 0 0 0 0 1.664l8 5A1 1 0 0 0 18 17.5v-11z"/>
                </svg>
              </button>

              <button id="playPauseBtn" aria-label="Play/Pause" class="text-white">
                <svg id="playIcon" class="w-9 h-9" viewBox="0 0 24 24" fill="currentColor">
                  <circle cx="12" cy="12" r="10" opacity=".18"></circle>
                  <path d="M10 8.5v7l6-3.5-6-3.5z"/>
                </svg>
                <svg id="pauseIcon" class="w-9 h-9 hidden" viewBox="0 0 24 24" fill="currentColor">
                  <circle cx="12" cy="12" r="10" opacity=".18"></circle>
                  <rect x="9" y="8" width="2.6" height="8" rx="0.6"></rect>
                  <rect x="12.4" y="8" width="2.6" height="8" rx="0.6"></rect>
                </svg>
              </button>

              <button id="nextBtn" aria-label="Next" class="text-white/95">
                <svg class="w-8 h-8" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M18 19a1 1 0 0 0 1-1V6a1 1 0 0 0-1-1h-1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h1z"/>
                  <path d="M6 6.5a1 1 0 0 1 1.55-.832l8 5a1 1 0 0 1 0 1.664l-8 5A1 1 0 0 1 6 17.5v-11z"/>
                </svg>
              </button>
            </div>

            <canvas id="waveformCanvas" class="ml-4"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== 재생바 & 볼륨바 ===== -->
    <section class="card p-4 mb-6">
      <div class="flex items-center gap-3">
        <span id="curTime" class="text-sm text-gray-600 min-w-[2.8rem] text-center">0:00</span>
        <input id="progressBar" class="flex-1" type="range" min="0" max="0" value="0" step="0.01" />
        <span id="totalTime" class="text-sm text-gray-600 min-w-[2.8rem] text-center">0:00</span>
        <div class="flex items-center gap-2 w-44">
          <svg class="w-5 h-5 text-gray-500" viewBox="0 0 24 24" fill="currentColor"><path d="M4 10v4h3l4 3V7L7 10H4z"/></svg>
          <input id="volumeSlider" type="range" min="0" max="100" step="1" value="100" class="w-full">
        </div>
      </div>
    </section>

    <!-- ===== 검색창 ===== -->
    <section class="card p-4 mb-4">
      <div class="flex w-full items-center gap-2">
        <input id="searchInput" type="text" placeholder="아티스트나 곡명을 검색하세요..." class="flex-grow px-4 py-2 bg-white border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition">
        <button id="searchButton" class="shrink-0 bg-purple-600 text-white px-5 py-2 rounded-r-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 transition-transform active:scale-95">검색</button>
      </div>
    </section>

    <!-- ===== 동시 표기: 위=Spotify / 아래=YouTube ===== -->
    <section class="card p-4 mb-4">
      <h3 class="font-bold text-green-600 mb-2">Spotify</h3>
      <div id="statusSpotify" class="text-center text-gray-500 mb-2 h-6"></div>
      <div id="spotifyResults" class="results-grid grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
    </section>

    <section class="card p-4">
      <h3 class="font-bold text-red-600 mb-2">YouTube</h3>
      <div id="statusYouTube" class="text-center text-gray-500 mb-2 h-6"></div>
      <div id="youtubeResults" class="results-grid grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
    </section>
  </div>

  <!-- ===== 설정 플로팅 버튼 & 패널 ===== -->
  <div class="fixed bottom-6 right-6 z-50">
    <button id="settingsIconBtn" class="bg-purple-600 text-white rounded-full p-3 shadow-lg hover:bg-purple-700 transition transform hover:scale-110 focus:outline-none" aria-label="설정" type="button">
      <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756.426-1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
    </button>

    <div id="settingsPanel" class="card absolute bottom-20 right-0 w-80 bg-white p-6 rounded-2xl shadow-2xl origin-bottom-right space-y-6">
      <div>
        <label class="block text-sm font-medium text-gray-700">표시 채널명</label>
        <div class="mt-1 flex items-center gap-2">
          <input id="displayNameInput" type="text" placeholder="채널명을 입력하세요" class="flex-1 min-w-0 h-10 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500">
          <button id="applyDisplayName" class="h-10 px-4 text-sm whitespace-nowrap bg-purple-500 text-white rounded-md hover:bg-purple-600" type="button">적용</button>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">커버 이미지 업로드</label>
        <div class="mt-2 flex flex-row flex-wrap items-center gap-2">
          <label class="cursor-pointer h-10 px-4 text-sm whitespace-nowrap bg-purple-500 text-white rounded-md hover:bg-purple-600 inline-flex items-center">
            <span>이미지 업로드</span>
            <input id="imageUpload" type="file" class="hidden" accept="image/*">
          </label>
          <button id="revertCover" class="h-10 px-4 text-sm whitespace-nowrap bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300" type="button">원래 썸네일</button>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">카드 색상</label>
        <div class="mt-2 flex flex-row flex-wrap items-center gap-2">
          <input id="primaryColor" type="color" value="#A855F7" class="w-10 h-10 p-1 border-0 rounded-md cursor-pointer">
          <input id="secondaryColor" type="color" value="#7C3AED" class="w-10 h-10 p-1 border-0 rounded-md cursor-pointer">
          <button id="applyColors" class="h-10 px-4 text-sm whitespace-nowrap bg-purple-500 text-white rounded-md hover:bg-purple-600" type="button">적용</button>
          <button id="resetColors" class="h-10 px-4 text-sm whitespace-nowrap bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300" type="button">기본</button>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">배경 색상</label>
        <div class="mt-2 flex items-center gap-2">
          <input id="bgColor" type="color" value="#ffffff" class="w-10 h-10 p-1 border-0 rounded-md cursor-pointer">
          <button id="applyBg" class="h-10 px-4 text-sm bg-purple-500 text-white rounded-md hover:bg-purple-600" type="button">적용</button>
          <button id="resetBg" class="h-10 px-4 text-sm bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300" type="button">기본</button>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">텍스트 크기</label>
        <div class="mt-2 space-y-3">
          <div>
            <div class="flex items-center justify-between text-xs text-gray-500 mb-1"><span>제목 크기</span><span id="titleSizeVal">18px</span></div>
            <input id="titleSize" type="range" min="14" max="36" step="1" value="18" class="w-full">
          </div>
          <div>
            <div class="flex items-center justify-between text-xs text-gray-500 mb-1"><span>정보 크기 (가수/채널)</span><span id="metaSizeVal">14px</span></div>
            <input id="metaSize" type="range" min="10" max="24" step="1" value="14" class="w-full">
          </div>
          <div class="flex gap-2">
            <button id="resetTextSize" class="h-9 px-3 text-sm bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300" type="button">기본</button>
          </div>
        </div>
      </div>

      <!-- 카드 레이아웃 토글 -->
      <div>
        <label class="block text-sm font-medium text-gray-700">카드 레이아웃</label>
        <div class="mt-2 flex gap-2">
          <button id="btnHorizontal" class="toggle-tab tab-active" type="button">가로형</button>
          <button id="btnVertical" class="toggle-tab tab-inactive" type="button">세로형</button>
        </div>
      </div>
    </div>
  </div>

  <!-- YouTube iframe host -->
  <div id="youtube-player-container" style="position: absolute; top: -9999px; left: -9999px;"></div>

<script>
  /* -------------------- DOM -------------------- */
  const albumArtImg = document.getElementById('albumArt');
  const trackTitleSpan = document.getElementById('trackTitle');
  const trackArtistSpan = document.getElementById('trackArtist');
  const artistNameP = document.getElementById('artistName');
  const waveformCanvas = document.getElementById('waveformCanvas');
  const playerCard = document.getElementById('player');

  const btnHorizontal = document.getElementById('btnHorizontal');
  const btnVertical   = document.getElementById('btnVertical');

  const searchInput = document.getElementById('searchInput');
  const searchButton = document.getElementById('searchButton');

  const playPauseBtn = document.getElementById('playPauseBtn');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const playIcon = document.getElementById('playIcon');
  const pauseIcon = document.getElementById('pauseIcon');

  const progressBar = document.getElementById('progressBar');
  const curTimeEl = document.getElementById('curTime');
  const totalTimeEl = document.getElementById('totalTime');
  const volumeSlider = document.getElementById('volumeSlider');

  const settingsIconBtn = document.getElementById('settingsIconBtn');
  const settingsPanel = document.getElementById('settingsPanel');
  const displayNameInput = document.getElementById('displayNameInput');
  const applyDisplayName = document.getElementById('applyDisplayName');

  const imageUpload = document.getElementById('imageUpload');
  const revertCover = document.getElementById('revertCover');

  const primaryColor = document.getElementById('primaryColor');
  const secondaryColor = document.getElementById('secondaryColor');
  const applyColors = document.getElementById('applyColors');
  const resetColors = document.getElementById('resetColors');
  const bgColor = document.getElementById('bgColor');
  const applyBg = document.getElementById('applyBg');
  const resetBg = document.getElementById('resetBg');

  const titleSize = document.getElementById('titleSize');
  const metaSize = document.getElementById('metaSize');
  const titleSizeVal = document.getElementById('titleSizeVal');
  const metaSizeVal = document.getElementById('metaSizeVal');
  const resetTextSize = document.getElementById('resetTextSize');

  const statusSpotify = document.getElementById('statusSpotify');
  const statusYouTube = document.getElementById('statusYouTube');
  const spotifyResults = document.getElementById('spotifyResults');
  const youtubeResults = document.getElementById('youtubeResults');

  /* -------------------- 상태 -------------------- */
  const PLACEHOLDER = albumArtImg.src;
  let originalAlbumArtUrl = PLACEHOLDER;
  let userCoverUrl = null;
  let useUserCover = false;

  let youtubePlayer;
  let currentPlaylist = []; // YouTube 전용
  let currentTrackIndex = -1;
  let isPlaying = false;
  let progressRaf = null;

  /* -------------------- 레이아웃 토글 -------------------- */
  function setLayout(mode){
    if(mode === 'vertical'){
      playerCard.classList.add('vertical');
      playerCard.dataset.layout = 'vertical';
      btnVertical.classList.remove('tab-inactive'); btnVertical.classList.add('tab-active');
      btnHorizontal.classList.remove('tab-active'); btnHorizontal.classList.add('tab-inactive');
    }else{
      playerCard.classList.remove('vertical');
      playerCard.dataset.layout = 'horizontal';
      btnHorizontal.classList.remove('tab-inactive'); btnHorizontal.classList.add('tab-active');
      btnVertical.classList.remove('tab-active'); btnVertical.classList.add('tab-inactive');
    }
    // 필요시 저장
    try { localStorage.setItem('cardLayout', mode); } catch(e){}
  }
  // 버튼 이벤트
  btnHorizontal.addEventListener('click', ()=>setLayout('horizontal'));
  btnVertical.addEventListener('click',   ()=>setLayout('vertical'));
  // 초기 로드 시 마지막 선택 적용
  (function(){
    const last = localStorage.getItem('cardLayout');
    if(last === 'vertical') setLayout('vertical'); else setLayout('horizontal');
  })();

  /* -------------------- YouTube Iframe API -------------------- */
  const tag = document.createElement('script');
  tag.src = "https://www.youtube.com/iframe_api";
  document.head.appendChild(tag);

  function onYouTubeIframeAPIReady() {
    youtubePlayer = new YT.Player('youtube-player-container', {
      height: '0', width: '0',
      playerVars: { 'autoplay': 0, 'controls': 0, 'rel': 0, 'showinfo': 0 },
      events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
    });
  }
  function onPlayerReady(e) { e.target.setVolume(volumeSlider.value); }
  function onPlayerStateChange(e) {
    isPlaying = (e.data === YT.PlayerState.PLAYING);
    playIcon.classList.toggle('hidden', isPlaying);
    pauseIcon.classList.toggle('hidden', !isPlaying);
    if (e.data === YT.PlayerState.ENDED) playNext();
  }

  /* -------------------- 컨트롤 -------------------- */
  function fmt(sec){
    if(!isFinite(sec)||sec<0) return '0:00';
    sec=Math.floor(sec);
    const m=Math.floor(sec/60), s=sec%60;
    return `${m}:${String(s).padStart(2,'0')}`;
  }

  function startProgressLoop(){
    if (progressRaf) cancelAnimationFrame(progressRaf);
    const loop = ()=>{
      const d=youtubePlayer?.getDuration?youtubePlayer.getDuration():0;
      totalTimeEl.textContent=fmt(d||0);
      progressBar.max=d||0;

      const t=youtubePlayer?.getCurrentTime?youtubePlayer.getCurrentTime():0;
      curTimeEl.textContent=fmt(t||0);
      if(!seeking) progressBar.value=t||0;

      progressRaf=requestAnimationFrame(loop);
    };
    progressRaf=requestAnimationFrame(loop);
  }

  function playTrack(index){
    if (index<0 || index>=currentPlaylist.length) return;
    currentTrackIndex=index;
    const track=currentPlaylist[index];
    youtubePlayer.loadVideoById(track.videoId);
    originalAlbumArtUrl=track.albumImage;
    if (!useUserCover) albumArtImg.src=track.albumImage;
    trackTitleSpan.textContent=track.name||'노래 제목';
    const artistNames=(track.artists||[]).map(a=>a.name).join(', ');
    trackArtistSpan.textContent=artistNames?`- ${artistNames}`:'';    
    startProgressLoop();
  }
  function togglePlayPause(){
    if(!youtubePlayer||currentTrackIndex===-1) return;
    isPlaying?youtubePlayer.pauseVideo():youtubePlayer.playVideo();
  }
  function playNext(){ if(currentPlaylist.length) playTrack((currentTrackIndex+1)%currentPlaylist.length); }
  function playPrev(){ if(currentPlaylist.length) playTrack((currentTrackIndex-1+currentPlaylist.length)%currentPlaylist.length); }

  playPauseBtn.addEventListener('click', togglePlayPause);
  nextBtn.addEventListener('click', playNext);
  prevBtn.addEventListener('click', playPrev);

  // 진행바/볼륨
  let seeking=false;
  progressBar.addEventListener('input', ()=>{
    seeking=true;
    curTimeEl.textContent=fmt(parseFloat(progressBar.value)||0);
  });
  const endSeek=()=>{
    const t=parseFloat(progressBar.value)||0;
    youtubePlayer?.seekTo&&youtubePlayer.seekTo(t,true);
    seeking=false;
  };
  ['change','pointerup','touchend','mouseup','keyup'].forEach(ev=>progressBar.addEventListener(ev,endSeek));
  volumeSlider.addEventListener('input', e => {
    const v=e.target.value;
    if(youtubePlayer?.setVolume) youtubePlayer.setVolume(v);
  });

  /* -------------------- API 키 -------------------- */
  const YOUTUBE_API_KEY = 'AIzaSyCydSU4s3HYDPKqEp37JIY8HdAmHvelHns';
  const SPOTIFY_CLIENT_ID = '13ada5c13a834887b16d181b5730a8b3';
  const SPOTIFY_CLIENT_SECRET = 'e29f437d6c3d46509926b78b0fd885fb';
  let spotifyToken=null, spotifyTokenExp=0;

  async function getSpotifyToken(){
    const now=Date.now();
    if(spotifyToken && now < spotifyTokenExp-10000) return spotifyToken;
    const body=new URLSearchParams({grant_type:'client_credentials'});
    const auth=btoa(`${SPOTIFY_CLIENT_ID}:${SPOTIFY_CLIENT_SECRET}`);
    const res=await fetch('https://accounts.spotify.com/api/token',{
      method:'POST',
      headers:{'Authorization':`Basic ${auth}`,'Content-Type':'application/x-www-form-urlencoded'},
      body
    });
    if(!res.ok) throw new Error('Spotify 토큰 발급 실패');
    const data=await res.json();
    spotifyToken=data.access_token;
    spotifyTokenExp=Date.now()+data.expires_in*1000;
    return spotifyToken;
  }

  /* -------------------- 검색 -------------------- */
  function clearResults(){
    spotifyResults.innerHTML='';
    youtubeResults.innerHTML='';
    statusSpotify.textContent='';
    statusYouTube.textContent='';
  }

  function makeCard(track, index, mode){
    const card=document.createElement('div');
    card.className='bg-white rounded-xl p-3 cursor-pointer hover:shadow-lg transition-shadow';
    const artistNames=(track.artists||[]).map(a=>a.name).join(', ');
    card.innerHTML=`
      <div class="relative">
        <img src="${track.albumImage}" alt="${track.name}" class="w-full rounded-lg shadow-sm aspect-square object-cover">
      </div>
      <div class="mt-2 text-center">
        <p class="font-bold text-gray-900 truncate text-sm" title="${track.name}">${track.name}</p>
        <p class="text-xs text-gray-600 truncate" title="${artistNames}">${artistNames}</p>
      </div>`;
    card.addEventListener('click', ()=>{
      if(mode==='youtube'){
        playTrack(index);
      }else{
        // Spotify: 메타만 적용
        originalAlbumArtUrl=track.albumImage;
        if(!useUserCover) albumArtImg.src=track.albumImage;
        trackTitleSpan.textContent=track.name||'노래 제목';
        trackArtistSpan.textContent=artistNames?`- ${artistNames}`:'';
      }
    });
    return card;
  }

  async function searchYouTube(q){
    if(!YOUTUBE_API_KEY){ statusYouTube.textContent='YouTube API 키 필요'; return []; }
    const url=`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(q)}&key=${encodeURIComponent(YOUTUBE_API_KEY)}&type=video&maxResults=24&videoCategoryId=10`;
    try{
      const res=await fetch(url);
      const data=await res.json();
      if(!res.ok){
        statusYouTube.textContent=(data?.error?.message)||'API 오류';
        return [];
      }
      return (data.items||[]).map(item=>({
        videoId:item.id.videoId,
        name:item.snippet.title,
        artists:[{name:item.snippet.channelTitle}],
        albumImage:item.snippet.thumbnails.high?.url || item.snippet.thumbnails.medium?.url || PLACEHOLDER
      }));
    }catch{
      statusYouTube.textContent='네트워크 오류';
      return [];
    }
  }

  async function searchSpotify(q){
    try{
      const token=await getSpotifyToken();
      const url=`https://api.spotify.com/v1/search?q=${encodeURIComponent(q)}&type=track&limit=24`;
      const res=await fetch(url,{headers:{Authorization:`Bearer ${token}`}});
      if(!res.ok){
        const e=await res.json().catch(()=>({}));
        statusSpotify.textContent=(e?.error?.message||e?.error?.reason||'API 오류');
        return [];
      }
      const data=await res.json();
      const items=data?.tracks?.items||[];
      return items.map(it=>({
        name:it.name,
        artists:(it.artists||[]).map(a=>({name:a.name})),
        albumImage:it.album?.images?.[0]?.url || PLACEHOLDER
      }));
    }catch{
      statusSpotify.textContent='네트워크/인증 오류';
      return [];
    }
  }

  async function performSearch(){
    const q=searchInput.value.trim();
    clearResults();
    if(!q) return;
    statusSpotify.textContent='Spotify 검색 중...';
    statusYouTube.textContent='YouTube 검색 중...';

    const [spList, ytList] = await Promise.all([searchSpotify(q), searchYouTube(q)]);

    statusSpotify.textContent = spList.length? '' : '검색 결과가 없습니다.';
    statusYouTube.textContent = ytList.length? '' : '검색 결과가 없습니다.';

    spList.forEach((t,i)=> spotifyResults.appendChild(makeCard(t,i,'spotify')));
    currentPlaylist = ytList;
    ytList.forEach((t,i)=> youtubeResults.appendChild(makeCard(t,i,'youtube')));
  }

  document.getElementById('searchButton').addEventListener('click', performSearch);
  searchInput.addEventListener('keyup', e=>{ if(e.key==='Enter') performSearch(); });
  searchInput.addEventListener('input', ()=>{ if (!searchInput.value.trim()) clearResults(); });

  /* -------------------- 설정/스타일 컨트롤 -------------------- */
  document.getElementById('settingsIconBtn').addEventListener('click', ()=>{
    settingsPanel.classList.toggle('open');
  });
  applyDisplayName.addEventListener('click', ()=>{
    const v=displayNameInput.value.trim();
    if(v) artistNameP.textContent=v;
  });

  imageUpload.addEventListener('change', e=>{
    const file=e.target.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=ev=>{ userCoverUrl=ev.target.result; useUserCover=true; albumArtImg.src=userCoverUrl; };
    reader.readAsDataURL(file);
  });
  revertCover.addEventListener('click', ()=>{
    useUserCover=false; userCoverUrl=null; albumArtImg.src=originalAlbumArtUrl||PLACEHOLDER;
  });

  applyColors.addEventListener('click', ()=>{
    document.documentElement.style.setProperty('--ply-primary', primaryColor.value);
    document.documentElement.style.setProperty('--ply-secondary', secondaryColor.value);
  });
  resetColors.addEventListener('click', ()=>{
    primaryColor.value='#A855F7'; secondaryColor.value='#7C3AED'; applyColors.click();
  });

  applyBg.addEventListener('click', ()=>{
    document.documentElement.style.setProperty('--bg-color', bgColor.value);
  });
  resetBg.addEventListener('click', ()=>{
    bgColor.value='#ffffff'; applyBg.click();
  });

  titleSize.addEventListener('input', e=>{
    const v=`${e.target.value}px`;
    titleSizeVal.textContent=v;
    document.documentElement.style.setProperty('--title-size', v);
  });
  metaSize.addEventListener('input', e=>{
    const v=`${e.target.value}px`;
    metaSizeVal.textContent=v;
    document.documentElement.style.setProperty('--meta-size', v);
  });
  resetTextSize.addEventListener('click', ()=>{
    titleSize.value=18; metaSize.value=14;
    titleSize.dispatchEvent(new Event('input'));
    metaSize.dispatchEvent(new Event('input'));
  });

  /* -------------------- Waveform -------------------- */
  function initWaveform(canvas, options = {}) {
    if (!canvas) return;
    const cfg = {
      barCount:18,gap:3,smoothing:0.08,
      baseSpeedHz:0.6,rippleSpeedHz:1.2,
      baseWeight:0.75,rippleWeight:0.25,
      minRatio:0.25,maxRatio:0.85,
      fillStyle:'rgba(255,255,255,0.88)',
      glowBlur:6,glowColor:'rgba(255,255,255,0.35)',
      ...options
    };
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const ctx = canvas.getContext('2d');
    let prevHeights=new Array(cfg.barCount).fill(0);
    let lastW=0,lastH=0, startedAt=null;
    const easeCos=t=>0.5*(1-Math.cos(Math.PI*2*t));

    function resizeIfNeeded(){
      const cssW=canvas.clientWidth||120, cssH=canvas.clientHeight||40;
      if(cssW!==lastW||cssH!==lastH){
        lastW=cssW; lastH=cssH;
        canvas.width=Math.floor(cssW*dpr);
        canvas.height=Math.floor(cssH*dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0);
      }
    }
    function roundRect(ctx,x,y,w,h,r){
      const rr=Math.min(r,w*.5,h*.5);
      ctx.beginPath();
      ctx.moveTo(x+rr,y);
      ctx.lineTo(x+w-rr,y);
      ctx.quadraticCurveTo(x+w,y,x+w,y+rr);
      ctx.lineTo(x+w,y+h-rr);
      ctx.quadraticCurveTo(x+w,y+h,x+w-rr,y+h);
      ctx.lineTo(x+rr,y+h);
      ctx.quadraticCurveTo(x,y+h,x,y+h-rr);
      ctx.lineTo(x,y+rr);
      ctx.quadraticCurveTo(x,y,x+rr,y);
      ctx.closePath();
    }
    function render(ts){
      if(!startedAt) startedAt=ts;
      const t=(ts-startedAt)/1000;
      resizeIfNeeded();
      const W=canvas.clientWidth, H=canvas.clientHeight;
      ctx.clearRect(0,0,W,H);
      const barWidth=Math.max(2,(W-(cfg.barCount-1)*cfg.gap)/cfg.barCount);
      ctx.shadowBlur=cfg.glowBlur; ctx.shadowColor=cfg.glowColor;
      for(let i=0;i<cfg.barCount;i++){
        const base=easeCos((t*cfg.baseSpeedHz + i*0.18)%1);
        const ripple=easeCos((t*cfg.rippleSpeedHz + i*0.35)%1);
        const mix=cfg.baseWeight*base + cfg.rippleWeight*ripple;
        const ratio=cfg.minRatio + (cfg.maxRatio-cfg.minRatio)*mix;
        const target=H*ratio;
        const h=prevHeights[i]+(target-prevHeights[i])*cfg.smoothing;
        prevHeights[i]=h;
        const x=i*(barWidth+cfg.gap), y=H-h, r=Math.min(3,barWidth*0.35);
        roundRect(ctx,x,y,barWidth,h,r);
        ctx.fillStyle=cfg.fillStyle; ctx.fill();
      }
      ctx.shadowBlur=0; ctx.shadowColor='transparent';
      requestAnimationFrame(render);
    }
    requestAnimationFrame(render);
  }
  initWaveform(waveformCanvas);
</script>
</body>
</html>
